---
import config from "@/config.json";

import { Image } from "astro:assets";
import { getEntries } from "astro:content";

import dateFormat from "@/lib/utils/dateFormat";
import { humanize, plainify, slugify } from "@/lib/utils/textConverter";
import { FaUserPen } from "react-icons/fa6";

import Button from "@/components/ui-astro/Button.astro";

// Properties
const {
  summary_length,
  news_folder,
}: { summary_length: number; news_folder: string } = config.settings;

const { data } = Astro.props;
const { title, description, images, categories, date, authors, tags } =
  data.data;
const patternId = `pattern-${data.id}`;

const firstImage = images && images.length > 0 ? images[0] : null;

const people = await getEntries<"people">(authors);
---

<article
  class="group hover:border-primary bg-background relative isolate flex flex-col gap-6 overflow-hidden rounded-xl border-2 p-6 duration-100 hover:-translate-y-3 hover:[box-shadow:_var(--sh-alt)]"
>
  <!-- SVG background pattern on hover -->
  <svg
    class="text-primary pointer-events-none invisible absolute inset-0 z-[-1] size-full [mask-image:linear-gradient(to_left,_#ffffffad,_transparent)] opacity-100 select-none group-hover:visible dark:opacity-80"
  >
    <defs>
      <pattern
        id={patternId}
        width="4"
        height="4"
        patternUnits="userSpaceOnUse"
        patternTransform="rotate(45)"
      >
        <line
          x1="0"
          y1="0"
          x2="0"
          y2="4"
          stroke="currentColor"
          stroke-width="1.5"></line>
      </pattern>
    </defs>
    <rect width="100%" height="100%" fill={`url(#${patternId})`}></rect>
  </svg>

  <!-- Image Column -->
  {
    // 3. Check for the existence of 'firstImage' before trying to render it.
    firstImage && (
      <a
        class="relative h-48 overflow-hidden rounded-lg md:h-64"
        href={`/${news_folder}/${data.id}`}
      >
        <Image
          class="h-full w-full object-cover"
          src={firstImage.src}
          alt={firstImage.alt || title}
          width={445}
          height={230}
          format="webp"
        />
      </a>
    )
  }

  <!-- Content Column -->
  <div class="flex flex-col justify-between">
    <section>
      <header>
        <h3
          class="group-hover:text-primary mb-2 line-clamp-2 text-xl font-bold"
        >
          <a href={`/${news_folder}/${data.id}`}>{title}</a>
        </h3>
        <!-- categories -->
        {
          categories?.length > 0 && (
            <div class="flex items-center">
              <div class="flex flex-wrap gap-2">
                {categories.map((category: string) => (
                  <>
                    <a
                      href={`/tags/${slugify(category)}`}
                      class="text-primary border-primary bg-primary/5 flex h-[18px] w-fit shrink-0 items-center gap-1.5 rounded-xs border border-dotted px-1 font-mono text-[0.625rem] leading-6"
                    >
                      {humanize(category)}
                    </a>
                  </>
                ))}
              </div>
            </div>
          )
        }
      </header>

      <!-- Author and Date -->
      <div class="my-4 flex flex-col flex-wrap gap-1 text-sm">
        <!-- Author -->
        <!-- <div class="flex flex-row items-center">
          {
            people.map((author) => (
              <>
                <FaUserPen className="mr-2 flex-shrink-0" />
                <a class="hover:text-primary" href={`/people/${author.id}`}>
                  {humanize(author.id)}
                </a>
              </>
            ))
          }
        </div> -->
        <!-- Date -->
        {
          date && (
            <div class="text-foreground/70 flex items-center">
              <time class="text-2xs flex flex-wrap gap-2 font-mono">
                {dateFormat(date)}
              </time>
            </div>
          )
        }
      </div>

      <div class="border-t sm:pl-6 md:col-span-1">
        <p class="mt-2 mb-4 line-clamp-3">
          {plainify(data.body?.slice(0, Number(summary_length))) + "..."}
        </p>
      </div>
    </section>

    <div class="space-y-4">
      <Button
        variant="default"
        href={`/${news_folder}/${data.id}`}
        className="bg-primary/60"
      >
        Read More
      </Button>
    </div>
  </div>
</article>
