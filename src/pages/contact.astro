---
import config from "@/config.json";
import Main from "@/layouts/Main.astro";
import PageHeader from "@/components/blocks/PageHeader.astro";
import DynamicIcon from "@/components/blocks/DynamicIcon";
import Button from "@/components/ui-astro/Button.astro"; // Added import for the Button component

const { params } = config;
const content = {
  title: "Contact",
  messageTitle: "Send Us a Message",
};
---

<Main content={content} makara>
  <PageHeader title={content.title} />
  <section
    class="prose dark:prose-invert relative mx-auto grid max-w-6xl grid-cols-6 gap-6 p-2 pb-24 xl:gap-16"
  >
    <div class="relative col-span-6 min-w-full px-10 font-light lg:col-span-3">
      <h1 class="text-primary mt-8 mb-4 scroll-mt-24">Contact Us!</h1>
      <article
        id="contactDescription"
        class="mt-4 translate-y-0 space-y-4 opacity-100 transition-all duration-300 ease-in-out"
      >
        <p>
          For any inquiries regarding potential collaborations, feel free to
          reach us through any of our socials or through the following form:
        </p>
      </article>
      <article
        class="bg-background dark:shadow-primary/20 right-0 mx-auto mt-6 w-full max-w-xl rounded-xl border p-2.5 px-10 pb-10 font-light shadow-xl"
      >
        <h3>{content.messageTitle}</h3>

        <form
          id="contactForm"
          method="POST"
          data-contact-url={params.contact_form_url}
        >
          <div class="mb-4">
            <label for="name" class="form-label">
              Full Name <span class="text-red-500">*</span>
            </label>
            <input
              id="name"
              name="name"
              class="form-input w-full"
              placeholder="Budi Susanti"
              type="text"
              autocomplete="name"
              required
            />
          </div>

          <div class="mb-4 hidden" aria-hidden="true">
            <label for="website" class="form-label">Website</label>
            <input
              id="website"
              name="website"
              class="form-input w-full"
              placeholder="champs-ui.org"
              type="text"
              autocomplete="off"
            />
          </div>

          <div class="mb-4">
            <label for="email" class="form-label">
              Working e-Mail <span class="text-red-500">*</span>
            </label>
            <input
              id="email"
              name="email"
              class="form-input w-full"
              placeholder="budi.susanti@email.com"
              type="email"
              autocomplete="email"
              required
            />
          </div>

          <div class="mb-4">
            <label for="message" class="form-label">
              Message <span class="text-red-500">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              class="form-input w-full"
              placeholder="Message goes here..."
              rows="6"
              required
            >
            </textarea>
          </div>

          <div class="flex items-center gap-3">
            <Button id="submitBtn" type="submit"> Submit </Button>
            <div id="inline-badge" class="inline-block"></div>
          </div>
        </form>
      </article>
    </div>
    <article
      class="bg-background dark:shadow-primary/20 right-0 col-span-6 mx-auto mt-6 max-w-xl rounded-xl border p-2.5 px-10 pb-10 font-light shadow-xl lg:col-span-3"
    >
      <div>
        <!-- <h3>Telephone and Facsimile</h3>
        <ul>
          <a href="https://wa.me/+6281234567890">
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="LuPhone" />
              <a
                href="tel:62217867370"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
                target="_blank"
                rel="noopener noreferrer"
              >
                +62 (217) 867370
              </a>
            </li>
          </a>
          <li class="flex flex-row items-center gap-2">
            <DynamicIcon icon="LuRoute" />
            +62 (217) 867370
          </li>
        </ul>
      </div>
      <div> -->
        <h3>Email and Website</h3>
        <ul>
          <li class="flex flex-row items-center gap-2">
            <DynamicIcon icon="LuMail" />
            <a
              href="mailto:champs@ui.ac.id"
              class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
              target="_blank"
              rel="noopener noreferrer"
            >
              champs@ui.ac.id
            </a>
          </li>
          <li class="flex flex-row items-center gap-2">
            <DynamicIcon icon="LuMail" />
            <a
              href="mailto:champsui09@gmail.com"
              class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
              target="_blank"
              rel="noopener noreferrer"
            >
              champsui09@gmail.com
            </a>
          </li>
          <li class="flex flex-row items-center gap-2">
            <DynamicIcon icon="LuGlobe" />
            <a
              href="/"
              class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
            >
              www.champs-ui.org
            </a>
          </li>
        </ul>

        <div>
          <h3>Social Media</h3>
          <ul>
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="FaWhatsapp" />
              <a
                href="https://wa.me/+6281324096624"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
              >
                +62 813 2409 6624
              </a>
            </li>
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="LuFacebook" />
              <a
                href="https://www.facebook.com/champs.fkmui"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
                target="_blank"
                rel="noopener noreferrer"
              >
                Champs FKM UI
              </a>
            </li>
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="LuLinkedin" />
              <a
                href="https://www.linkedin.com/company/champsui"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
                target="_blank"
                rel="noopener noreferrer"
              >
                Champs FKM UI
              </a>
            </li>
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="LuInstagram" />
              <a
                href="https://www.instagram.com/champs_ui"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
              >
                @champs_UI
              </a>
            </li>
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="LuYoutube" />
              <a
                href="https://youtube.com/@champsfphui?si=uADFIoR8DUT7m-RV"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
              >
                Pusat Kajian AKK FKM UI
              </a>
            </li>
          </ul>
          <div>
            <h3>Address</h3>
            <span>
              <span>Room 312, Building G, 3rd Floor of</span>
              <a
                href="https://maps.app.goo.gl/7TDV2YcWJNLNM9o37"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
                target="_blank"
                rel="noopener noreferrer"
                set:html="Faculty of Public Health Universitas Indonesia Depok, West Java Indonesia"
              />
              <iframe
                src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d15860.710822775349!2d106.828982!3d-6.371044!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x2e69ec0551c05d25%3A0x6038c0c86578fe45!2sFaculty%20of%20Public%20Health%2C%20Universitas%20Indonesia!5e0!3m2!1sen!2sid!4v1758544468303!5m2!1sen!2sid"
                allowfullscreen=""
                class="mt-5 h-[300px] w-full rounded-2xl"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"></iframe>
            </span>
          </div>
        </div>
      </div>
    </article>
  </section>
</Main>

<script is:inline>
  function setupContactForm() {
    const form = document.getElementById("contactForm");
    if (!form) return; // Exit if form doesn't exist

    // Prevent multiple initializations on the same form
    if (form.dataset.initialized) return;
    form.dataset.initialized = "true";

    const submitBtn = document.getElementById("submitBtn");
    const recaptchaSiteKey = "6LckcswrAAAAAD9Y9Erk6tzAOWtdZXGiUKpNc_dh"; // Your reCAPTCHA Site Key

    // Dynamically load the reCAPTCHA script if it's not already present
    if (!window.grecaptcha) {
      const script = document.createElement("script");
      script.src = `https://www.google.com/recaptcha/api.js?render=${recaptchaSiteKey}`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const url = form.dataset.contactUrl;
      const honeypot = form.website.value.trim();

      // Honeypot check for bots
      if (honeypot) {
        console.log("Bot detected!");
        return;
      }

      // Disable button and show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      try {
        // Wait for reCAPTCHA to be ready
        grecaptcha.ready(async () => {
          const token = await grecaptcha.execute(recaptchaSiteKey, {
            action: "submit",
          });

          const formData = new FormData(form);
          formData.append("recaptchaToken", token);

          const response = await fetch(url, {
            method: "POST",
            body: formData, // Send as FormData, which Apps Script handles well
          });

          if (!response.ok) {
            throw new Error(
              `Network response was not ok: ${response.statusText}`,
            );
          }

          const result = await response.json();

          if (result.status === "success") {
            alert(
              `Thank you, ${form.name.value.trim()}! Your message has been sent.`,
            );
            form.reset();
          } else {
            // Use the error message from the server if available
            throw new Error(result.message || "An unknown error occurred.");
          }
        });
      } catch (error) {
        console.error("Submission Error:", error);
        alert(`Submission failed: ${error.message}`);
      } finally {
        // Re-enable button regardless of outcome
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit";
      }
    });
  }

  // Set up the form on initial load and after Astro's page transitions
  document.addEventListener("astro:page-load", setupContactForm);
</script>
