---
import config from "@/config.json";
import Main from "@/layouts/Main.astro";
import PageHeader from "@/components/blocks/PageHeader.astro";
import DynamicIcon from "@/components/blocks/DynamicIcon";
import Button from "@/components/ui-astro/Button.astro"; // Added import for the Button component

const { params } = config;
const content = {
  title: "Contact",
  messageTitle: "Send Us a Message",
};
---

<Main content={content} makara>
  <PageHeader title={content.title} />
  <section
    class="prose dark:prose-invert relative mx-auto grid max-w-6xl grid-cols-6 gap-6 p-2 pb-24 xl:gap-16"
  >
    <div class="relative col-span-6 min-w-full px-10 font-light lg:col-span-3">
      <h1 class="text-primary mt-8 mb-4 scroll-mt-24">Contact Us!</h1>
      <article
        id="contactDescription"
        class="mt-4 translate-y-0 space-y-4 opacity-100 transition-all duration-300 ease-in-out"
      >
        <p>
          For any inquiries regarding potential collaborations, feel free to
          reach us through any of our socials or through the following form:
        </p>
      </article>
      <article
        class="bg-background dark:shadow-primary/20 right-0 mx-auto mt-6 w-full max-w-xl rounded-xl border p-2.5 px-10 pb-10 font-light shadow-xl"
      >
        <h3>{content.messageTitle}</h3>

        <form
          id="contactForm"
          method="POST"
          data-contact-url={params.contact_form_url}
        >
          <div class="mb-4">
            <label for="name" class="form-label">
              Full Name <span class="text-red-500">*</span>
            </label>
            <input
              id="name"
              name="name"
              class="form-input w-full"
              placeholder="Budi Susanti"
              type="text"
              autocomplete="name"
              required
            />
          </div>

          <div class="mb-4 hidden" aria-hidden="true">
            <label for="website" class="form-label">Website</label>
            <input
              id="website"
              name="website"
              class="form-input w-full"
              placeholder="champs-ui.org"
              type="text"
              autocomplete="off"
            />
          </div>

          <div class="mb-4">
            <label for="email" class="form-label">
              Working e-Mail <span class="text-red-500">*</span>
            </label>
            <input
              id="email"
              name="email"
              class="form-input w-full"
              placeholder="budi.susanti@email.com"
              type="email"
              autocomplete="email"
              required
            />
          </div>

          <div class="mb-4">
            <label for="message" class="form-label">
              Message <span class="text-red-500">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              class="form-input w-full"
              placeholder="Message goes here..."
              rows="6"
              required
            >
            </textarea>
          </div>

          <div class="flex items-center gap-3">
            <Button id="submitBtn" type="submit"> Submit </Button>
            <div id="inline-badge" class="inline-block"></div>
          </div>
        </form>
      </article>
    </div>
    <article
      class="bg-background dark:shadow-primary/20 right-0 col-span-6 mx-auto mt-6 max-w-xl rounded-xl border p-2.5 px-10 pb-10 font-light shadow-xl lg:col-span-3"
    >
      <div>
        <!-- <h3>Telephone and Facsimile</h3>
        <ul>
          <a href="https://wa.me/+6281234567890">
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="LuPhone" />
              <a
                href="tel:62217867370"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
                target="_blank"
                rel="noopener noreferrer"
              >
                +62 (217) 867370
              </a>
            </li>
          </a>
          <li class="flex flex-row items-center gap-2">
            <DynamicIcon icon="LuRoute" />
            +62 (217) 867370
          </li>
        </ul>
      </div>
      <div> -->
        <h3>Email and Website</h3>
        <ul>
          <li class="flex flex-row items-center gap-2">
            <DynamicIcon icon="LuMail" />
            <a
              href="mailto:champs@ui.ac.id"
              class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
              target="_blank"
              rel="noopener noreferrer"
            >
              champs@ui.ac.id
            </a>
          </li>
          <li class="flex flex-row items-center gap-2">
            <DynamicIcon icon="LuMail" />
            <a
              href="mailto:champsui09@gmail.com"
              class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
              target="_blank"
              rel="noopener noreferrer"
            >
              champsui09@gmail.com
            </a>
          </li>
          <li class="flex flex-row items-center gap-2">
            <DynamicIcon icon="LuGlobe" />
            <a
              href="/"
              class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
            >
              www.champs-ui.org
            </a>
          </li>
        </ul>

        <div>
          <h3>Social Media</h3>
          <ul>
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="FaWhatsapp" />
              <a
                href="https://wa.me/+6281324096624"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
              >
                +62 813 2409 6624
              </a>
            </li>
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="LuFacebook" />
              <a
                href="https://www.facebook.com/champs.fkmui"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
                target="_blank"
                rel="noopener noreferrer"
              >
                Champs FKM UI
              </a>
            </li>
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="LuLinkedin" />
              <a
                href="https://www.linkedin.com/company/champsui"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
                target="_blank"
                rel="noopener noreferrer"
              >
                Champs FKM UI
              </a>
            </li>
            <li class="flex flex-row items-center gap-2">
              <DynamicIcon icon="LuInstagram" />
              <a
                href="https://www.instagram.com/champs_ui"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
              >
                @champs_UI
              </a>
            </li>
          </ul>
          <div>
            <h3>Address</h3>
            <span>
              <span>Room 312, Building G, 3rd Floor of</span>
              <a
                href="https://maps.app.goo.gl/7TDV2YcWJNLNM9o37"
                class="font-light underline decoration-black/20 underline-offset-4 hover:decoration-black dark:decoration-white/50 dark:hover:decoration-white"
                target="_blank"
                rel="noopener noreferrer"
                set:html="Faculty of Public Health Universitas Indonesia Depok, West Java Indonesia"
              />
            </span>
          </div>
        </div>
      </div>
    </article>
  </section>
</Main>

<script is:inline>
  function setupContactPage() {
    // Part 1: Programmatically load the reCAPTCHA script
    // This ensures the script is loaded every time the user navigates to this page.
    // We check if the script already exists to avoid loading it multiple times.
    if (!document.querySelector('script[src*="recaptcha/api.js"]')) {
      const recaptchaScript = document.createElement("script");
      recaptchaScript.src =
        "https://www.google.com/recaptcha/api.js?render=6LckcswrAAAAAD9Y9Erk6tzAOWtdZXGiUKpNc_dh";
      recaptchaScript.async = true;
      recaptchaScript.defer = true;
      document.head.appendChild(recaptchaScript);
    }

    // Part 2: Set up the form, just like before
    const form = document.getElementById("contactForm");
    if (!form) {
      return; // Exit if the form isn't on the current page
    }

    // --- Start of existing form logic ---
    const validateField = (field) => {
      const isValid = field.checkValidity();
      field.classList.toggle("is-invalid", !isValid);
    };

    form
      .querySelectorAll("input[required], textarea[required]")
      .forEach((field) => {
        field.addEventListener("input", () => validateField(field));
        field.addEventListener("blur", () => validateField(field));
      });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");

      grecaptcha.ready(async () => {
        const url = form.dataset.contactUrl;
        const website = form.website.value.trim();
        if (website) return;

        try {
          const token = await grecaptcha.execute(
            "6LckcswrAAAAAD9Y9Erk6tzAOWtdZXGiUKpNc_dh",
            { action: "submit" },
          );

          const name = form.name.value.trim();
          const email = form.email.value.trim();
          const message = form.message.value.trim();
          if (!name || !email || !message) {
            throw new Error("All fields are required");
          }
          submitBtn.disabled = true;
          submitBtn.textContent = "Submitting...";

          const response = await fetch(url, {
            method: "POST",
            body: new URLSearchParams({
              name: name,
              email: email,
              message: message,
              recaptchaToken: token,
            }),
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          });

          const result = await response.json();
          if (result.status === "success") {
            // The 'message' variable is already available from the outer scope
            alert(
              `Thank you, ${name}!\nWe'll respond to ${email} within 24 hours.\n\nYour message:\n"${message}"`,
            );
            form.reset();
          } else {
            throw new Error(result.message || "Submission failed");
          }
        } catch (error) {
          alert(error.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit";
        }
      });
    });
  }

  // Run the setup function on initial page load and after every client-side navigation
  document.addEventListener("astro:page-load", setupContactPage);
</script>
